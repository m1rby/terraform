<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Terraform LogViewer</title>
  <style>
    :root {
      --bg: #ffffff;
      --bg-muted: #f6f8fa;
      --surface: #ffffff;
      --border: #e5e7eb;
      --text: #0f172a;
      --text-muted: #475569;
      --accent: #2563eb;
      --accent-600: #1d4ed8;
      --chip: #f1f5f9;
      --chip-border: #e2e8f0;
      --code-bg: #0a0f1c;
      --code-border: #1f2a44;
      --badge: #334155;
      --mark-bg: #2563eb;
      --mark-fg: #ffffff;
      --control-h: 42px;
    }

    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background: var(--bg); color: var(--text); }

    header { position: sticky; top: 0; z-index: 10; background: var(--surface); border-bottom: 1px solid var(--border); }
    .navbar { display: flex; align-items: center; gap: 14px; padding: 12px 24px; }
    .brand { display: inline-flex; align-items: center; gap: 10px; }
    .brand img { height: 24px; width: auto; display: block; }
    .brand h1 { font-size: 18px; margin: 0; letter-spacing: 0.2px; color: var(--text); }
    .nav-spacer { flex: 1; }
    .nav-actions { display: inline-flex; gap: 8px; }

    main { padding: 16px 24px; }

    .tabs { display: flex; gap: 6px; align-items: center; overflow-x: auto; padding-bottom: 6px; }
    .tab { display: inline-flex; align-items: center; gap: 8px; padding: 6px 10px; border-radius: 999px; border: 1px solid var(--chip-border); background: var(--chip); cursor: pointer; white-space: nowrap; color: var(--text); }
    .tab .dot { width: 10px; height: 10px; border-radius: 999px; display: inline-block; border: 1px solid var(--chip-border); }
    .tab.active { border-color: var(--accent); background: #e8f0ff; }
    .tab.drag-over { outline: 2px dashed var(--accent); }
    .tab .close { width: 16px; height: 16px; border-radius: 999px; display: inline-flex; align-items: center; justify-content: center; font-size: 12px; color: var(--text-muted); border: 1px solid var(--chip-border); }
    .tab .close:hover { background: #e2e8f0; }
    .tab-add { width: 28px; height: 28px; border-radius: 999px; border: 1px dashed var(--chip-border); background: var(--chip); color: var(--text-muted); display: inline-flex; align-items: center; justify-content: center; cursor: pointer; }

    .panel { display: grid; gap: 12px; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 14px; box-shadow: 0 1px 2px rgba(16,24,40,0.04); }
    .panel-row { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; }

    .tokenbox { display: flex; align-items: center; gap: 8px; padding: 0 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-muted); min-height: var(--control-h); }
    .tokenbox-inner { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; width: 100%; }
    #searchText { outline: none; border: none; background: transparent; color: var(--text); font: inherit; min-width: 160px; flex: 1; height: var(--control-h); line-height: var(--control-h); }

    .toolbar { display: inline-grid; grid-auto-flow: column; gap: 8px; align-items: stretch; }
    .icon-btn { height: var(--control-h); min-width: var(--control-h); display: inline-flex; align-items: center; justify-content: center; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); cursor: pointer; transition: background .15s ease, transform .06s ease; padding: 0 10px; color: var(--text); font-size: 12px; font-weight: 500; }
    .icon-btn:hover { background: #eef2ff; }
    .icon-btn:active { transform: translateY(1px); }
    .icon-btn.active { background: #e8f0ff; border-color: var(--accent); }
    .icon-img { width: 18px; height: 18px; display: block; }
    .toolbar-row { display: grid; grid-template-columns: auto auto auto; gap: 6px; align-items: stretch; }
    .export-btn { height: var(--control-h); padding: 0 16px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 13px; min-width: 150px; display: inline-flex; align-items: center; justify-content: center; }
    .export-btn:hover { background: #eef2ff; }
    .timeline-btn { height: var(--control-h); padding: 0 16px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 13px; min-width: 255px; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; transition: background .15s ease; }
    .timeline-btn:hover { background: #eef2ff; }

    .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid var(--border); color: var(--text-muted); font-size: 12px; }
    .summary-row { display: flex; align-items: center; gap: 8px; justify-content: space-between; }
    .sort-calendar-btn { width: 32px; height: 32px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); cursor: pointer; display: inline-flex; align-items: center; justify-content: center; transition: all .2s ease; }
    .sort-calendar-btn:hover { background: #eef2ff; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.08); }
    .sort-calendar-btn:active { transform: translateY(0); }
    .sort-calendar-btn.active { background: #e8f0ff; border-color: var(--accent); }
    .sort-calendar-btn img { width: 18px; height: 18px; display: block; opacity: 0.7; transition: opacity .2s ease; }
    .sort-calendar-btn:hover img { opacity: 1; }
    .sort-calendar-btn.active img { opacity: 1; }
    .list { display: grid; gap: 8px; margin-top: 14px; }
    .item { border: 1px solid var(--border); border-radius: 8px; background: var(--surface); }
    .item-header { display: grid; grid-template-columns: 200px 90px 90px 1fr 220px 90px; gap: 8px; padding: 8px 12px; align-items: center; cursor: pointer; }
    .item-header:hover { background: var(--bg-muted); }
    .time { color: #2563eb; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size: 12px; }
    .level { text-transform: uppercase; font-weight: 600; font-size: 11px; }
    .level.info { color: #16a34a; }
    .level.debug { color: #2563eb; }
    .level.trace { color: #7c3aed; }
    .level.warn { color: #d97706; }
    .level.error { color: #dc2626; }
    .section { color: var(--text-muted); font-size: 12px; }
    .msg { color: var(--text); white-space: pre-wrap; }
    .msg mark { background: var(--mark-bg); color: var(--mark-fg); padding: 0 2px; border-radius: 3px; }
    .read-toggle { background: var(--bg); color: var(--text); border: 1px solid var(--border); border-radius: 8px; padding: 4px 8px; font-size: 12px; cursor: pointer; }
    .read-toggle.active { border-color: #22c55e; color: #16a34a; background: #ecfdf5; }
    .item.read { opacity: 0.65; }

    .details { display: none; padding: 10px 12px 12px; border-top: 1px dashed var(--border); }
    .details-grid { display: grid; grid-template-columns: 1fr 48%; gap: 12px; align-items: start; }
    .kv { display: grid; grid-template-columns: 180px 1fr; gap: 6px 12px; }
    .code { background: var(--code-bg); border: 1px solid var(--code-border); border-radius: 8px; padding: 8px 10px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size: 12px; color: #dbeafe; overflow: auto; max-height: 280px; }
    .muted { color: var(--text-muted); }
    .filename { text-align: right; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .overlay { position: fixed; inset: 0; background: rgba(2,6,23,0.3); display: none; z-index: 30; }
    .drawer { position: fixed; right: 24px; top: 72px; width: 420px; max-width: calc(100% - 48px); background: var(--surface); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); display: none; z-index: 40; }
    .drawer header { padding: 12px 14px; border-bottom: 1px solid var(--border); background: var(--bg-muted); border-top-left-radius: 12px; border-top-right-radius: 12px; }
    .drawer main { padding: 12px 14px; display: grid; gap: 12px; }
    .field { display: grid; grid-template-columns: 140px 1fr; gap: 8px 10px; align-items: center; }
    .field input, .field select { padding: 8px 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text); }
    .drawer .actions { display: flex; gap: 8px; justify-content: flex-end; align-items:center; padding: 12px 14px; border-top: 1px dashed var(--border); }
    .btn-primary { background: var(--accent); color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; }
    .btn-primary:hover { background: var(--accent-600); }
    .btn-secondary { background: var(--bg); color: var(--text); border: 1px solid var(--border); padding: 8px 12px; border-radius: 8px; cursor: pointer; }
    .presets { display: flex; gap: 6px; flex-wrap: wrap; }
    .preset { background: var(--chip); border:1px solid var(--chip-border); color: var(--text); padding:6px 10px; border-radius:999px; cursor:pointer; font-size:12px; }
    .preset:hover { background:#e2e8f0; }

    /* Timeline panel */
    .timeline-panel { display: none; }
    .timeline-page { display: none; padding: 20px; background: #f8fafc; min-height: calc(100vh - 120px); }
    .timeline-page.active { display: block; }
    .timeline-page-header { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: space-between; }
    .timeline-page-header h2 { margin: 0; font-size: 20px; font-weight: 600; color: #1e293b; }
    .timeline-controls { display: flex; gap: 10px; align-items: center; }
    .gantt-time-axis { display: flex; justify-content: space-between; padding: 8px 0; margin-bottom: 12px; border-bottom: 2px solid #e2e8f0; }
    .gantt-time-tick { font-size: 11px; color: #64748b; font-weight: 500; text-align: center; }
    .timeline-body { overflow: auto; }
    
    .gantt-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 20px; }
    .gantt-stat { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid #2563eb; }
    .gantt-stat-label { font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: #64748b; margin-bottom: 8px; font-weight: 500; }
    .gantt-stat-value { font-size: 28px; font-weight: 700; color: #1e293b; }
    
    .gantt-container { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .gantt { display:grid; grid-template-columns: 280px 1fr; gap: 12px; align-items: center; }
    .gantt-row { display: contents; }
    .gantt-label { padding: 10px 14px; color: #1e293b; font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0; transition: all 0.2s ease; cursor: pointer; }
    .gantt-label:hover { background: #e0e7ff; border-color: #a5b4fc; transform: translateX(4px); }
    
    .gantt-track { position: relative; height: 36px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; overflow: visible; }
    .gantt-bar { position: absolute; top: 4px; height: 28px; border-radius: 6px; background: #3b82f6; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; padding: 0 8px; color: white; font-size: 11px; font-weight: 600; overflow: hidden; }
    .gantt-bar:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59,130,246,0.3); z-index: 10; }
    
    .gantt-bar.warn { background: #f59e0b; }
    .gantt-bar.warn:hover { box-shadow: 0 4px 12px rgba(245,158,11,0.3); }
    .gantt-bar.error { background: #ef4444; }
    .gantt-bar.error:hover { box-shadow: 0 4px 12px rgba(239,68,68,0.3); }
    .gantt-bar.info { background: #10b981; }
    .gantt-bar.info:hover { box-shadow: 0 4px 12px rgba(16,185,129,0.3); }
    .gantt-bar.trace { background: #8b5cf6; }
    .gantt-bar.trace:hover { box-shadow: 0 4px 12px rgba(139,92,246,0.3); }
    
    .gantt-grid { position: absolute; inset: 0; background-image: repeating-linear-gradient(90deg, rgba(148,163,184,0.1) 0px, rgba(148,163,184,0.1) 1px, transparent 1px, transparent 100px); pointer-events: none; border-radius: 8px; }
    
    .gantt-tooltip { position: fixed; background: #1e293b; color: white; padding: 12px 16px; border-radius: 8px; font-size: 12px; pointer-events: none; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: none; max-width: 300px; }
    .gantt-tooltip-title { font-weight: 600; font-size: 13px; margin-bottom: 8px; color: white; }
    .gantt-tooltip-row { display: flex; justify-content: space-between; gap: 12px; margin: 4px 0; font-size: 12px; }
    .gantt-tooltip-label { color: #cbd5e1; }
    .gantt-tooltip-value { font-weight: 600; color: white; }
    

    /* Rename modal */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(2,6,23,0.35); display: none; z-index: 70; }
    .modal { position: fixed; inset: 0; display: none; z-index: 80; align-items: center; justify-content: center; }
    .modal .dialog { width: 420px; max-width: calc(100% - 48px); background: var(--surface); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 12px 48px rgba(0,0,0,0.14); }
    .modal header { padding: 10px 14px; border-bottom: 1px solid var(--border); background: var(--bg-muted); border-top-left-radius: 12px; border-top-right-radius: 12px; }
    .modal main { padding: 12px 14px; }
    .modal footer { padding: 12px 14px; border-top: 1px dashed var(--border); display: flex; gap: 8px; justify-content: flex-end; }
    #renameInput { width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font: inherit; }
    .color-row { display:flex; align-items:center; gap:8px; margin-top:8px; }
    #renameColor { width: 44px; height: 32px; padding: 0; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); }
  </style>
</head>
<body>
  <header>
    <div class="navbar">
      <div class="brand">
        <img src="images/logo.png" alt="logo" />
        <h1>Terraform LogViewer</h1>
      </div>
      <div class="nav-spacer"></div>
    </div>
  </header>
  <main>
    <div class="tabs" id="tabs"></div>

    <div class="panel">
      <div class="panel-row">
        <div class="tokenbox" id="tokenBox">
          <div class="tokenbox-inner">
            <input id="searchText" placeholder="поиск по тексту (message/raw)…" />
          </div>
        </div>
        <div class="toolbar">
          <input type="file" id="file" style="display:none" />
          <button id="uploadIcon" class="icon-btn" title="Загрузить логи"><img class="icon-img" src="images/upload.png" alt="upload"/></button>
          <div class="toolbar-row">
            <button id="settingsIcon" class="icon-btn" title="Фильтры"><img class="icon-img" src="images/settings.png" alt="filters"/></button>
            <button id="exportBtn" class="export-btn" title="Экспорт JSON">EXPORT</button>
          </div>
        </div>
      </div>
      <div class="summary-row">
        <div style="display: flex; align-items: center; gap: 8px;">
          <div class="muted" id="summary"></div>
          <button id="sortCalendarBtn" class="sort-calendar-btn" title="Сортировка по времени (клик для переключения)"><img src="images/sorting.png" alt="sort"/></button>
        </div>
        <button id="timelineBtn" class="timeline-btn" title="Диаграмма Ганта">СТАТИСТИКА</button>
      </div>
    </div>

    <div id="results" class="list"></div>

    <div id="timelinePage" class="timeline-page">
      <div class="timeline-page-header">
        <h2 id="timelinePageTitle">Диаграмма Ганта</h2>
        <div class="timeline-controls">
          <button id="timelineClose" class="btn-primary">Закрыть</button>
        </div>
      </div>
      <div class="timeline-body">
        <div id="ganttStats" class="gantt-stats"></div>
        <div class="gantt-container">
          <div id="gantt" class="gantt"></div>
        </div>
      </div>
    </div>
  </main>

  <div id="overlay" class="overlay"></div>
  <div id="filtersDrawer" class="drawer" role="dialog" aria-modal="true" aria-labelledby="filtersTitle">
    <header>
      <div class="muted" id="filtersTitle">Фильтры</div>
    </header>
    <main>
      <div class="presets" id="datePresets">
        <button class="preset" data-preset="today">Сегодня</button>
        <button class="preset" data-preset="yesterday">Вчера</button>
        <button class="preset" data-preset="24h">Последние 24ч</button>
        <button class="preset" data-preset="7d">Последние 7 дней</button>
      </div>
      <div class="field">
        <div class="muted">Дата (одна)</div>
        <input id="fDate" type="date" />
      </div>
      <div class="field">
        <div class="muted">Диапазон</div>
        <select id="fRange">
          <option value="day">День</option>
          <option value="24h">Последние 24ч</option>
          <option value="7d">Последние 7 дней</option>
        </select>
      </div>
      <div class="field">
        <div class="muted">Секция</div>
        <select id="fSection">
          <option value="">Любая</option>
          <option value="plan">plan</option>
          <option value="apply">apply</option>
        </select>
      </div>
      <div class="field">
        <div class="muted">Уровень</div>
        <select id="fLevel">
          <option value="">Любой</option>
          <option value="error">error</option>
          <option value="warn">warn</option>
          <option value="info">info</option>
          <option value="debug">debug</option>
          <option value="trace">trace</option>
        </select>
      </div>
      <div class="field">
        <div class="muted">Invalid</div>
        <select id="fInvalid">
          <option value="">Все</option>
          <option value="true">Только invalid</option>
          <option value="false">Только valid</option>
        </select>
      </div>
      <div class="field">
        <div class="muted">tf_req_id</div>
        <input id="fReqId" list="reqIdList" placeholder="substring или полный id" />
        <datalist id="reqIdList"></datalist>
      </div>
      <div class="field">
        <div class="muted">Убрать отмеченные</div>
        <label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="fHideRead" /> <span class="muted">скрыть логи с отметкой "Прочитано"</span></label>
      </div>
    </main>
    <div class="actions">
      <button id="filtersReset" class="btn-secondary">Сбросить</button>
      <button id="filtersApply" class="btn-primary">Применить</button>
    </div>
  </div>

  <div id="ganttTooltip" class="gantt-tooltip"></div>

  <!-- Rename Tab Modal -->
  <div id="renameBackdrop" class="modal-backdrop"></div>
  <div id="renameModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="renameTitle">
    <div class="dialog">
      <header><div class="muted" id="renameTitle">Переименовать вкладку</div></header>
      <main>
        <input id="renameInput" placeholder="Новое имя" />
        <div class="color-row">
          <span class="muted">Цвет</span>
          <input type="color" id="renameColor" value="#3b82f6" />
        </div>
      </main>
      <footer>
        <button id="renameCancel" class="btn-secondary">Отмена</button>
        <button id="renameSave" class="btn-primary">Сохранить</button>
      </footer>
    </div>
  </div>

  <script>
    // ---------- IndexedDB helpers ----------
    const DB_NAME = 'tlv_db_v1';
    const STORE_TABS = 'tabs'; // {id, title, baseSummary, filters, search, readIds}
    const STORE_ENTRIES = 'entries'; // key: id, value: {id, entries}

    function openDb() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, 1);
        req.onupgradeneeded = () => {
          const db = req.result;
          if (!db.objectStoreNames.contains(STORE_TABS)) db.createObjectStore(STORE_TABS, { keyPath: 'id' });
          if (!db.objectStoreNames.contains(STORE_ENTRIES)) db.createObjectStore(STORE_ENTRIES, { keyPath: 'id' });
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    async function dbGet(store, key) {
      const db = await openDb();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(store, 'readonly');
        const st = tx.objectStore(store);
        const rq = st.get(key);
        rq.onsuccess = () => resolve(rq.result || null);
        rq.onerror = () => reject(rq.error);
      });
    }

    async function dbPut(store, value) {
      const db = await openDb();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(store, 'readwrite');
        const st = tx.objectStore(store);
        const rq = st.put(value);
        rq.onsuccess = () => resolve(true);
        rq.onerror = () => reject(rq.error);
      });
    }

    async function dbDelete(store, key) {
      const db = await openDb();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(store, 'readwrite');
        const st = tx.objectStore(store);
        const rq = st.delete(key);
        rq.onsuccess = () => resolve(true);
        rq.onerror = () => reject(rq.error);
      });
    }

    async function dbGetAll(store) {
      const db = await openDb();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(store, 'readonly');
        const st = tx.objectStore(store);
        const rq = st.getAll();
        rq.onsuccess = () => resolve(rq.result || []);
        rq.onerror = () => reject(rq.error);
      });
    }

    // ---------- App State ----------
    const tabsEl = document.getElementById('tabs');
    const fileInput = document.getElementById('file');
    const uploadIcon = document.getElementById('uploadIcon');
    const settingsIcon = document.getElementById('settingsIcon');
    const overlay = document.getElementById('overlay');
    const drawer = document.getElementById('filtersDrawer');
    const timelineBtn = document.getElementById('timelineBtn');
    const timelinePanel = document.getElementById('timelinePanel');
    const timelineCloseBtn = document.getElementById('timelineClose');
    const timelineRefresh = document.getElementById('timelineRefresh');
    const ganttEl = document.getElementById('gantt');
    const exportBtn = document.getElementById('exportBtn');
    const sortCalendarBtn = document.getElementById('sortCalendarBtn');

    const results = document.getElementById('results');
    const summary = document.getElementById('summary');
    const search = document.getElementById('searchText');

    const fDate = document.getElementById('fDate');
    const fRange = document.getElementById('fRange');
    const fSection = document.getElementById('fSection');
    const fLevel = document.getElementById('fLevel');
    const fInvalid = document.getElementById('fInvalid');
    const fReqId = document.getElementById('fReqId');
    const reqIdList = document.getElementById('reqIdList');
    const fHideRead = document.getElementById('fHideRead');

    const filtersApply = document.getElementById('filtersApply');
    const filtersReset = document.getElementById('filtersReset');
    const datePresets = document.getElementById('datePresets');
    // no quick apply buttons anymore

    let activeTabId = null;
    let lastFiltered = [];
    let renamingTabId = null;
    let sortOrder = 'desc'; // 'asc' | 'desc'

    async function loadTabs() {
      const all = await dbGetAll(STORE_TABS);
      if (!all.length) {
        const id = crypto.randomUUID ? crypto.randomUUID() : String(Date.now());
        const tab = { id, title: 'Вкладка 1', color: '#94a3b8', baseSummary: '', search: '', filters: { date: '', range: 'day', section: '', level: '', invalid: '', reqId: '', hideRead: '' }, readIds: [], sort: 'desc', showGantt: false };
        await dbPut(STORE_TABS, tab);
        await dbPut(STORE_ENTRIES, { id, entries: [] });
        return [tab];
      }
      return all;
    }

    async function loadEntries(tabId) {
      const rec = await dbGet(STORE_ENTRIES, tabId);
      const arr = (rec && rec.entries) || [];
      for (const e of arr) { if (!e._id) e._id = crypto.randomUUID ? crypto.randomUUID() : String(Math.random()); }
      return arr;
    }

    async function saveTabMeta(tab) { await dbPut(STORE_TABS, tab); }
    async function saveTabEntries(tabId, entries) { await dbPut(STORE_ENTRIES, { id: tabId, entries }); }
    async function deleteTab(tabId) { await dbDelete(STORE_TABS, tabId); await dbDelete(STORE_ENTRIES, tabId); }

    async function renderTabs() {
      const allRaw = await dbGetAll(STORE_TABS);
      const all = allRaw.slice().sort((a,b) => {
        const ao = (typeof a.order === 'number') ? a.order : (a.createdAt || 0);
        const bo = (typeof b.order === 'number') ? b.order : (b.createdAt || 0);
        return ao - bo;
      });
      tabsEl.innerHTML = '';
      for (const t of all) {
        const el = document.createElement('div');
        el.className = 'tab' + (t.id === activeTabId ? ' active' : '');
        el.setAttribute('data-id', t.id);
        el.draggable = true;
        el.innerHTML = `<span class="tab-title" data-id="${t.id}"><span class="dot" style="background:${escapeHtml(t.color || '#94a3b8')}"></span> ${escapeHtml(t.title)}</span><span class="close" data-close="${t.id}">×</span>`;
        el.addEventListener('click', async (e) => {
          if (e.target.getAttribute('data-close')) return; // handled below
          activeTabId = t.id; await hydrateFromTab(t.id); await renderTabs();
        });
        // DnD handlers
        el.addEventListener('dragstart', (e) => {
          e.dataTransfer.setData('text/plain', t.id);
          e.dataTransfer.effectAllowed = 'move';
        });
        el.addEventListener('dragover', (e) => { e.preventDefault(); el.classList.add('drag-over'); });
        el.addEventListener('dragleave', () => { el.classList.remove('drag-over'); });
        el.addEventListener('drop', async (e) => {
          e.preventDefault(); el.classList.remove('drag-over');
          const draggedId = e.dataTransfer.getData('text/plain');
          const targetId = t.id;
          if (!draggedId || draggedId === targetId) return;
          await reorderTabs(draggedId, targetId);
          await renderTabs();
        });
        const titleEl = el.querySelector('.tab-title');
        titleEl.addEventListener('dblclick', async (e) => {
          e.stopPropagation();
          renamingTabId = t.id;
          const input = document.getElementById('renameInput');
          input.value = t.title || '';
          renameColor.value = (t.color || '#94a3b8');
          openRenameModal();
        });
        const closeBtn = el.querySelector('[data-close]');
        closeBtn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const tabs = await dbGetAll(STORE_TABS);
          if (tabs.length === 1) return; // keep at least one tab
          await deleteTab(t.id);
          const rest = await dbGetAll(STORE_TABS);
          activeTabId = (rest[0] && rest[0].id) || null;
          await renderTabs();
          if (activeTabId) await hydrateFromTab(activeTabId);
        });
        tabsEl.appendChild(el);
      }
      const addBtn = document.createElement('button');
      addBtn.className = 'tab-add'; addBtn.textContent = '+';
      addBtn.addEventListener('click', async () => {
        const id = crypto.randomUUID ? crypto.randomUUID() : String(Date.now());
        const maxOrder = Math.max(0, ...all.map(t => typeof t.order === 'number' ? t.order : (t.createdAt || 0)));
        const tab = { id, title: `Вкладка ${tabsEl.querySelectorAll('.tab').length + 1}`, color: '#94a3b8', baseSummary: '', search: '', filters: { date: '', range: 'day', section: '', level: '', invalid: '', reqId: '', hideRead: '' }, readIds: [], sort: 'desc', showGantt: false, createdAt: Date.now(), order: maxOrder + 1 };
        await dbPut(STORE_TABS, tab);
        await dbPut(STORE_ENTRIES, { id, entries: [] });
        activeTabId = id; await renderTabs(); await hydrateFromTab(id);
      });
      tabsEl.appendChild(addBtn);
    }

    async function reorderTabs(draggedId, targetId) {
      const tabs = await dbGetAll(STORE_TABS);
      // sort by current order
      const ordered = tabs.slice().sort((a,b) => {
        const ao = (typeof a.order === 'number') ? a.order : (a.createdAt || 0);
        const bo = (typeof b.order === 'number') ? b.order : (b.createdAt || 0);
        return ao - bo;
      });
      const draggedIdx = ordered.findIndex(t => t.id === draggedId);
      const targetIdx = ordered.findIndex(t => t.id === targetId);
      if (draggedIdx === -1 || targetIdx === -1) return;
      const [dragged] = ordered.splice(draggedIdx, 1);
      ordered.splice(targetIdx, 0, dragged);
      // reassign incremental order
      for (let i = 0; i < ordered.length; i++) {
        const t = ordered[i];
        t.order = i + 1;
        await saveTabMeta(t);
      }
    }

    async function hydrateFromTab(tabId) {
      const tab = await dbGet(STORE_TABS, tabId);
      if (!tab) return;
      search.value = tab.search || '';
      sortOrder = tab.sort || 'desc';
      fDate.value = (tab.filters && tab.filters.date) || '';
      fRange.value = (tab.filters && tab.filters.range) || 'day';
      fSection.value = (tab.filters && tab.filters.section) || '';
      fLevel.value = (tab.filters && tab.filters.level) || '';
      fInvalid.value = (tab.filters && tab.filters.invalid) || '';
      fHideRead.checked = (tab.filters && tab.filters.hideRead) === 'true';
      fReqId.value = (tab.filters && tab.filters.reqId) || '';
      baseSummary = tab.baseSummary || '';
      summary.textContent = baseSummary;
      readSet = new Set(tab.readIds || []);
      lastEntries = await loadEntries(tabId);
      applyFiltersAndRender();
      updateSortButtonsUI();
      updateGanttView();
    }

    function updateGanttView() {
      if (!activeTabId) return;
      dbGet(STORE_TABS, activeTabId).then(tab => {
        const showGantt = tab && tab.showGantt;
        if (showGantt) {
          const tabTitle = tab ? tab.title : 'Вкладка';
          timelinePageTitle.textContent = `Диаграмма для "${tabTitle}"`;
          renderGanttFromCurrent();
          resultsDiv.style.display = 'none';
          panelDiv.style.display = 'none';
          timelinePage.classList.add('active');
        } else {
          timelinePage.classList.remove('active');
          resultsDiv.style.display = '';
          panelDiv.style.display = '';
        }
      });
    }

    // ---------- UI events ----------
    uploadIcon.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', async () => {
      if (!fileInput.files?.length || !activeTabId) return;
      summary.textContent = 'Загрузка...';
      try {
        const fd = new FormData();
        fd.append('file', fileInput.files[0]);
        const res = await fetch('/upload', { method: 'POST', body: fd });
        const data = await res.json();
        const newEntries = (data && data.entries) || [];
        for (const e of newEntries) { e._id = crypto.randomUUID ? crypto.randomUUID() : String(Math.random()); }
        lastEntries = lastEntries.concat(newEntries);
        const src = (data && data.source_filename) || (fileInput.files[0] && fileInput.files[0].name) || '';
        baseSummary = `Добавлено: ${newEntries.length} из файла ${src}. Всего: ${lastEntries.length}`;
        summary.textContent = baseSummary;
        append(newEntries, getCurrentHighlight());
        await saveTabEntries(activeTabId, lastEntries);
        const tab = await dbGet(STORE_TABS, activeTabId);
        tab.baseSummary = baseSummary; await saveTabMeta(tab);
      } catch (e) {
        console.error(e);
        summary.textContent = 'Ошибка загрузки';
      }
      updateReqIdSuggestions();
    });

    function openDrawer() { overlay.style.display='block'; drawer.style.display='block'; }
    function closeDrawer() { overlay.style.display='none'; drawer.style.display='none'; }
    settingsIcon.addEventListener('click', openDrawer);
    overlay.addEventListener('click', closeDrawer);

    // sort button
    function updateSortButtonsUI() {
      if (sortCalendarBtn) {
        sortCalendarBtn.classList.toggle('active', sortOrder === 'asc');
        sortCalendarBtn.title = sortOrder === 'asc' ? 'Сортировка: сначала старые (↑)' : 'Сортировка: сначала новые (↓)';
      }
    }
    async function saveSort() { if (!activeTabId) return; const tab = await dbGet(STORE_TABS, activeTabId); tab.sort = sortOrder; await saveTabMeta(tab); }
    if (sortCalendarBtn) {
      sortCalendarBtn.addEventListener('click', async () => {
        sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
        updateSortButtonsUI();
        await saveSort();
        applyFiltersAndRender();
      });
    }

    const timelinePage = document.getElementById('timelinePage');
    const timelinePageTitle = document.getElementById('timelinePageTitle');
    const resultsDiv = document.getElementById('results');
    const panelDiv = document.querySelector('.panel');

    timelineBtn.addEventListener('click', async () => {
      if (!activeTabId) return;
      const tab = await dbGet(STORE_TABS, activeTabId);
      tab.showGantt = true;
      await saveTabMeta(tab);
      updateGanttView();
    });
    timelineCloseBtn.addEventListener('click', async () => {
      if (!activeTabId) return;
      const tab = await dbGet(STORE_TABS, activeTabId);
      tab.showGantt = false;
      await saveTabMeta(tab);
      updateGanttView();
    });

    datePresets.addEventListener('click', (e) => {
      const btn = e.target.closest('.preset');
      if (!btn) return;
      const kind = btn.getAttribute('data-preset');
      const now = new Date();
      const pad = (n) => String(n).padStart(2,'0');
      const toISO = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      if (kind === 'today') { fDate.value = toISO(now); fRange.value = 'day'; }
      if (kind === 'yesterday') { const y = new Date(now); y.setDate(y.getDate()-1); fDate.value = toISO(y); fRange.value = 'day'; }
      if (kind === '24h') { fDate.value = toISO(now); fRange.value = '24h'; }
      if (kind === '7d') { fDate.value = toISO(now); fRange.value = '7d'; }
    });

    // no quick apply buttons anymore

    filtersApply.addEventListener('click', async () => { closeDrawer(); await saveFilters(); applyFiltersAndRender(); });
    filtersReset.addEventListener('click', async () => { fSection.value=''; fLevel.value=''; fInvalid.value=''; fDate.value=''; fRange.value='day'; fReqId.value=''; fHideRead.checked = false; await saveFilters(); applyFiltersAndRender(); });

    search.addEventListener('input', async () => { await saveSearch(); applyFiltersAndRender(); });
    search.addEventListener('keydown', async (e) => { if (e.key==='Enter') { e.preventDefault(); await saveSearch(); applyFiltersAndRender(); } });

    fReqId.addEventListener('input', () => { applyFiltersAndRender(); });

    async function saveSearch() { if (!activeTabId) return; const tab = await dbGet(STORE_TABS, activeTabId); tab.search = search.value; await saveTabMeta(tab); }
    async function saveFilters() { if (!activeTabId) return; const tab = await dbGet(STORE_TABS, activeTabId); tab.filters = { date: fDate.value, range: fRange.value, section: fSection.value, level: fLevel.value, invalid: fInvalid.value, reqId: fReqId.value, hideRead: fHideRead.checked ? 'true' : '' }; await saveTabMeta(tab); }
    async function saveReadSet() { if (!activeTabId) return; const tab = await dbGet(STORE_TABS, activeTabId); tab.readIds = Array.from(readSet); await saveTabMeta(tab); }
    async function saveReqId() { if (!activeTabId) return; const tab = await dbGet(STORE_TABS, activeTabId); tab.filters = { ...tab.filters, reqId: fReqId.value }; await saveTabMeta(tab); }

    function getRangeFromControls() {
      if (!fDate.value) return { from: null, to: null };
      const base = new Date(fDate.value + 'T00:00:00');
      const from = new Date(base);
      let to = new Date(base);
      if (fRange.value === 'day') { to.setHours(23,59,59,999); }
      if (fRange.value === '24h') { to = new Date(); from.setDate(from.getDate()-1); }
      if (fRange.value === '7d') { to = new Date(); from.setDate(from.getDate()-7); }
      return { from, to };
    }

    function applyFiltersAndRender() {
      const text = search.value;
      const { from, to } = getRangeFromControls();
      const section = fSection.value || null;
      const level = fLevel.value || null;
      const invalid = fInvalid.value === '' ? null : fInvalid.value === 'true';
      const reqId = (fReqId.value || '').trim().toLowerCase();
      const hideRead = !!fHideRead.checked;

      const filtered = lastEntries.filter(e => {
        if (hideRead && e && e._id && readSet.has(e._id)) return false;
        if (from || to) {
          const d = entryTimestampToDate(e); if (!d) return false;
          if (from && d < from) return false; if (to && d > to) return false;
        }
        if (section && String(e.tf_section||'').toLowerCase() !== section) return false;
        if (level && String(e.level||'').toLowerCase() !== level) return false;
        if (invalid !== null && Boolean(e.invalid) !== invalid) return false;
        if (reqId) {
          const idv = String(e.tf_req_id || e.rf_req_id || '').toLowerCase();
          if (!idv.includes(reqId)) return false;
        }
        if (text && text.trim()) {
          const hay = `${e.message ?? ''}\n${e.raw ?? ''}`.toLowerCase();
          if (!hay.includes(text.toLowerCase())) return false;
        }
        return true;
      });

      const sorted = filtered.slice().sort((a, b) => {
        const ta = entryTimestampToDate(a);
        const tb = entryTimestampToDate(b);
        const da = ta ? ta.getTime() : 0;
        const db = tb ? tb.getTime() : 0;
        return sortOrder === 'asc' ? (da - db) : (db - da);
      });

      render(sorted, getCurrentHighlight());
      updateSummaryFound(sorted.length);
      // обновим список req_id по текущим данным (без повторов)
      updateReqIdSuggestions(sorted);
      lastFiltered = sorted;
    }

    function getCurrentHighlight() { const t = search.value.trim(); return t.length ? t : ''; }

    function updateSummaryFound(n) { const base = baseSummary || ''; summary.textContent = base ? `${base} • Найдено: ${n}` : `Найдено: ${n}`; }

    function entryTimestampToDate(e) {
      if (!e.timestamp) return null;
      const t = Date.parse(e.timestamp); if (!isNaN(t)) return new Date(t);
      const cleaned = String(e.timestamp).replace(',', '.'); const t2 = Date.parse(cleaned); return isNaN(t2) ? null : new Date(t2);
    }

    function render(items, highlight) { results.innerHTML = ''; append(items, highlight); }
    function append(items, highlight) { for (const e of items) results.appendChild(renderItem(e, highlight)); }

    function renderItem(e, highlight) {
      const item = document.createElement('div'); item.className = 'item';
      if (readSet.has(e._id)) item.classList.add('read');
      const lvl = (e.level || 'info').toLowerCase();
      const section = e.tf_section ? `${e.tf_section}${e.tf_section_boundary ? ' • ' + e.tf_section_boundary : ''}` : '';
      const src = e.source_filename ? `<span class="badge">${escapeHtml(e.source_filename)}</span>` : '';
      const invalid = e.invalid ? `<span class="badge" style="border-color:#7f1d1d;color:#fca5a5">INVALID</span>` : '';
      const msgHtml = highlightText(escapeHtml(e.message || ''), highlight);
      item.innerHTML = `
        <div class="item-header" data-toggle>
          <div class="time">${e.timestamp || ''}</div>
          <div class="level ${lvl}">${lvl}</div>
          <div class="section">${section} ${invalid}</div>
          <div class="msg">${msgHtml}</div>
          <div class="filename">${src}</div>
          <div><button class="read-toggle${readSet.has(e._id) ? ' active' : ''}" data-id="${e._id}">${readSet.has(e._id) ? 'Прочитано' : 'Отметить'}</button></div>
        </div>
        <div class="details" hidden>
          <div class="details-grid">
            <div>
              <div class="kv">
                <div class="muted">invalid</div><div>${e.invalid ? 'true' : 'false'}</div>
                <div class="muted">source</div><div>${displayOrDash(e.source_filename)}</div>
                <div class="muted">tf_req_id</div><div>${e.tf_req_id ? `<button class="btn-secondary" data-req="${escapeHtml(e.tf_req_id)}" style="padding:2px 6px">${escapeHtml(e.tf_req_id)}</button>` : '<span class="muted">—</span>'}</div>
                <div class="muted">module</div><div>${displayOrDash(e.module)}</div>
                <div class="muted">caller</div><div>${displayOrDash(e.caller)}</div>
                <div class="muted">tf_provider_addr</div><div>${displayOrDash(e.tf_provider_addr)}</div>
                <div class="muted">tf_rpc</div><div>${displayOrDash(e.tf_rpc)}</div>
                <div class="muted">tf_resource_type</div><div>${displayOrDash(e.tf_resource_type)}</div>
                <div class="muted">tf_proto_version</div><div>${displayOrDash(e.tf_proto_version)}</div>
                <div class="muted">HTTP Request</div><div>${renderCode(e.tf_http_req_body, highlight)}</div>
                <div class="muted">HTTP Response</div><div>${renderCode(e.tf_http_res_body, highlight)}</div>
              </div>
            </div>
            <div>
              <div class="muted">raw</div>
              ${renderRawPretty(e.raw, e.raw_pretty, highlight)}
            </div>
          </div>
        </div>
      `;
      const header = item.querySelector('[data-toggle]'); const details = item.querySelector('.details');
      header.addEventListener('click', () => { const open = details.style.display === 'block'; details.style.display = open ? 'none' : 'block'; details.hidden = open; });
      const btn = item.querySelector('.read-toggle');
      btn.addEventListener('click', async (ev) => {
        ev.stopPropagation();
        const id = btn.getAttribute('data-id');
        if (readSet.has(id)) { readSet.delete(id); item.classList.remove('read'); btn.classList.remove('active'); btn.textContent='Отметить'; }
        else { readSet.add(id); item.classList.add('read'); btn.classList.add('active'); btn.textContent='Прочитано'; }
        await saveReadSet();
      });
      // click tf_req_id button
      const reqBtn = item.querySelector('[data-req]');
      if (reqBtn) {
        reqBtn.addEventListener('click', (ev) => {
          ev.stopPropagation();
          fReqId.value = reqBtn.getAttribute('data-req');
          applyFiltersAndRender();
          saveFilters();
        });
      }
      return item;
    }

    function renderCode(body, highlight) {
      if (!body) return '<span class="muted">—</span>';
      try {
        const obj = typeof body === 'string' ? JSON.parse(body) : body;
        const pretty = JSON.stringify(obj, null, 2);
        return `<pre class="code">${highlightText(escapeHtml(pretty), highlight)}</pre>`;
      } catch {
        return `<pre class="code">${highlightText(escapeHtml(String(body)), highlight)}</pre>`;
      }
    }

    function renderRawPretty(raw, raw_pretty, highlight) {
      if (!raw && !raw_pretty) return '<span class="muted">—</span>';
      const text = raw_pretty || (() => { try { return JSON.stringify(JSON.parse(raw), null, 2); } catch { return raw || ''; } })();
      return `<pre class="code">${highlightText(escapeHtml(text), highlight)}</pre>`;
    }

    function highlightText(htmlEscaped, term) {
      if (!term || !term.trim()) return htmlEscaped;
      try {
        const safe = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const re = new RegExp(safe, 'ig');
        return htmlEscaped.replace(re, m => `<mark>${m}</mark>`);
      } catch { return htmlEscaped; }
    }

    function displayOrDash(value) { const has = value !== undefined && value !== null && String(value).trim() !== ''; return has ? escapeHtml(String(value)) : '<span class="muted">—</span>'; }
    function escapeHtml(str) { return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;'); }

    // ======== Timeline (Gantt) ========
    const ganttTooltip = document.getElementById('ganttTooltip');
    const ganttStatsEl = document.getElementById('ganttStats');

    function renderGanttFromCurrent() {
      const text = search.value;
      const { from, to } = getRangeFromControls();
      const section = fSection.value || null;
      const level = fLevel.value || null;
      const invalid = fInvalid.value === '' ? null : fInvalid.value === 'true';
      const reqId = (fReqId.value || '').trim().toLowerCase();

      const filtered = lastEntries.filter(e => {
        if (from || to) {
          const d = entryTimestampToDate(e); if (!d) return false;
          if (from && d < from) return false; if (to && d > to) return false;
        }
        if (section && String(e.tf_section||'').toLowerCase() !== section) return false;
        if (level && String(e.level||'').toLowerCase() !== level) return false;
        if (invalid !== null && Boolean(e.invalid) !== invalid) return false;
        if (reqId) { const idv = String(e.tf_req_id || e.rf_req_id || '').toLowerCase(); if (!idv.includes(reqId)) return false; }
        if (text && text.trim()) { const hay = `${e.message ?? ''}\n${e.raw ?? ''}`.toLowerCase(); if (!hay.includes(text.toLowerCase())) return false; }
        return true;
      });

      // группировка по tf_req_id (пропускаем unknown)
      const groups = new Map();
      for (const e of filtered) {
        const key = e.tf_req_id || e.rf_req_id || e.tf_rpc;
        if (!key || key === 'unknown') continue;
        if (!groups.has(key)) groups.set(key, []);
        groups.get(key).push(e);
      }

      // статистика
      const stats = { total: filtered.length, groups: groups.size, errors: 0, warns: 0, info: 0, trace: 0 };
      for (const e of filtered) {
        const lvl = (e.level || '').toLowerCase();
        if (lvl === 'error') stats.errors++;
        else if (lvl === 'warn') stats.warns++;
        else if (lvl === 'info') stats.info++;
        else if (lvl === 'trace') stats.trace++;
      }

      // рендер статистики
      ganttStatsEl.innerHTML = `
        <div class="gantt-stat"><div class="gantt-stat-label">Всего логов</div><div class="gantt-stat-value">${stats.total}</div></div>
        <div class="gantt-stat"><div class="gantt-stat-label">Групп</div><div class="gantt-stat-value">${stats.groups}</div></div>
        <div class="gantt-stat" style="border-left-color: #ef4444;"><div class="gantt-stat-label">Errors</div><div class="gantt-stat-value" style="color: #ef4444;">${stats.errors}</div></div>
        <div class="gantt-stat" style="border-left-color: #f59e0b;"><div class="gantt-stat-label">Warnings</div><div class="gantt-stat-value" style="color: #f59e0b;">${stats.warns}</div></div>
        <div class="gantt-stat" style="border-left-color: #10b981;"><div class="gantt-stat-label">Info</div><div class="gantt-stat-value" style="color: #10b981;">${stats.info}</div></div>
        <div class="gantt-stat" style="border-left-color: #8b5cf6;"><div class="gantt-stat-label">Trace</div><div class="gantt-stat-value" style="color: #8b5cf6;">${stats.trace}</div></div>
      `;

      // вычисление min/max времени
      const stamps = [];
      for (const arr of groups.values()) {
        for (const e of arr) { const d = entryTimestampToDate(e); if (d) stamps.push(d.getTime()); }
      }
      if (!stamps.length) { ganttEl.innerHTML = '<div style="padding:20px;text-align:center;color:#64748b;">Нет данных для диаграммы</div>'; return; }
      const minT = Math.min(...stamps), maxT = Math.max(...stamps);
      const span = Math.max(1, maxT - minT);

      // рендер временной оси
      const timeAxisHtml = [];
      const tickCount = 6;
      for (let i = 0; i <= tickCount; i++) {
        const t = minT + (span * i / tickCount);
        const d = new Date(t);
        const timeStr = d.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        timeAxisHtml.push(`<div class="gantt-time-tick">${timeStr}</div>`);
      }
      
      ganttEl.innerHTML = '';
      const timeAxis = document.createElement('div');
      timeAxis.className = 'gantt-time-axis';
      timeAxis.style.gridColumn = '2';
      timeAxis.innerHTML = timeAxisHtml.join('');
      ganttEl.appendChild(document.createElement('div')); // пустой элемент для первой колонки
      ganttEl.appendChild(timeAxis);
      const sortedGroups = Array.from(groups.entries()).sort((a, b) => {
        const aStart = Math.min(...a[1].map(e => entryTimestampToDate(e)).filter(Boolean).map(d => d.getTime()));
        const bStart = Math.min(...b[1].map(e => entryTimestampToDate(e)).filter(Boolean).map(d => d.getTime()));
        return aStart - bStart;
      });

      for (const [key, arr] of sortedGroups) {
        const times = arr.map(e => entryTimestampToDate(e)).filter(Boolean).map(d => d.getTime());
        const start = Math.min(...times), end = Math.max(...times);
        const duration = end - start;
        const left = ((start - minT) / span) * 100;
        const width = Math.max(2, ((end - start) / span) * 100);
        const label = key.length > 35 ? key.substring(0, 32) + '...' : key;
        
        // определение уровня по приоритету
        const levels = arr.map(e => (e.level||'').toLowerCase());
        let lvl = 'info';
        if (levels.includes('error')) lvl = 'error';
        else if (levels.includes('warn')) lvl = 'warn';
        else if (levels.includes('trace')) lvl = 'trace';
        else if (levels.includes('info')) lvl = 'info';

        const rowLabel = document.createElement('div');
        rowLabel.className = 'gantt-label';
        rowLabel.textContent = label;
        rowLabel.title = key;
        rowLabel.addEventListener('click', async () => { 
          fReqId.value = key; 
          applyFiltersAndRender(); 
          saveFilters(); 
          if (activeTabId) {
            const tab = await dbGet(STORE_TABS, activeTabId);
            tab.showGantt = false;
            await saveTabMeta(tab);
          }
          updateGanttView();
        });

        const track = document.createElement('div');
        track.className = 'gantt-track';
        const grid = document.createElement('div');
        grid.className = 'gantt-grid';
        track.appendChild(grid);

        const bar = document.createElement('div');
        bar.className = `gantt-bar ${lvl}`;
        bar.style.left = left + '%';
        bar.style.width = width + '%';
        
        const durationMs = duration;
        const durationText = durationMs < 1000 ? `${durationMs}ms` : `${(durationMs/1000).toFixed(2)}s`;
        if (width > 8) bar.textContent = durationText;

        bar.addEventListener('click', async () => { 
          fReqId.value = key; 
          applyFiltersAndRender(); 
          saveFilters(); 
          if (activeTabId) {
            const tab = await dbGet(STORE_TABS, activeTabId);
            tab.showGantt = false;
            await saveTabMeta(tab);
          }
          updateGanttView();
        });
        
        // tooltip
        bar.addEventListener('mouseenter', (e) => {
          ganttTooltip.innerHTML = `
            <div class="gantt-tooltip-title">${escapeHtml(key)}</div>
            <div class="gantt-tooltip-row"><span class="gantt-tooltip-label">Начало:</span><span class="gantt-tooltip-value">${new Date(start).toLocaleString('ru-RU')}</span></div>
            <div class="gantt-tooltip-row"><span class="gantt-tooltip-label">Конец:</span><span class="gantt-tooltip-value">${new Date(end).toLocaleString('ru-RU')}</span></div>
            <div class="gantt-tooltip-row"><span class="gantt-tooltip-label">Длительность:</span><span class="gantt-tooltip-value">${durationText}</span></div>
            <div class="gantt-tooltip-row"><span class="gantt-tooltip-label">Логов:</span><span class="gantt-tooltip-value">${arr.length}</span></div>
            <div class="gantt-tooltip-row"><span class="gantt-tooltip-label">Уровень:</span><span class="gantt-tooltip-value" style="color: ${lvl==='error'?'#fca5a5':lvl==='warn'?'#fcd34d':lvl==='trace'?'#c4b5fd':'#86efac'}">${lvl.toUpperCase()}</span></div>
          `;
          ganttTooltip.style.display = 'block';
        });
        bar.addEventListener('mousemove', (e) => {
          ganttTooltip.style.left = (e.clientX + 15) + 'px';
          ganttTooltip.style.top = (e.clientY + 15) + 'px';
        });
        bar.addEventListener('mouseleave', () => {
          ganttTooltip.style.display = 'none';
        });

        track.appendChild(bar);
        ganttEl.appendChild(rowLabel);
        ganttEl.appendChild(track);
      }
    }

    function updateReqIdSuggestions(source) {
      const src = Array.isArray(source) ? source : lastEntries;
      const set = new Set();
      for (const e of src) {
        const idv = e && (e.tf_req_id || e.rf_req_id);
        if (idv && String(idv).trim()) set.add(String(idv));
      }
      reqIdList.innerHTML = '';
      for (const id of Array.from(set).sort()) {
        const opt = document.createElement('option');
        opt.value = id; reqIdList.appendChild(opt);
      }
    }

    // Экспорт текущей выборки в JSON
    exportBtn.addEventListener('click', () => {
      try {
        // если нет актуальной выборки — пересчитать
        if (!Array.isArray(lastFiltered) || !lastFiltered.length) applyFiltersAndRender();
        const data = lastFiltered || [];
        const pretty = JSON.stringify(data, null, 2);
        const blob = new Blob([pretty], { type: 'application/json;charset=utf-8' });
        const ts = new Date();
        const pad = (n) => String(n).padStart(2,'0');
        const name = `logs_export_${ts.getFullYear()}${pad(ts.getMonth()+1)}${pad(ts.getDate())}_${pad(ts.getHours())}${pad(ts.getMinutes())}${pad(ts.getSeconds())}.json`;
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = name; document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
      } catch (e) { console.error(e); }
    });

    // Rename modal logic
    const renameBackdrop = document.getElementById('renameBackdrop');
    const renameModal = document.getElementById('renameModal');
    const renameInput = document.getElementById('renameInput');
    const renameSave = document.getElementById('renameSave');
    const renameCancel = document.getElementById('renameCancel');
    const renameColor = document.getElementById('renameColor');

    function openRenameModal() {
      renameBackdrop.style.display = 'block';
      renameModal.style.display = 'flex';
      setTimeout(() => { try { renameInput.focus(); renameInput.select(); } catch {} }, 0);
    }
    function closeRenameModal() {
      renameBackdrop.style.display = 'none';
      renameModal.style.display = 'none';
    }
    renameCancel.addEventListener('click', closeRenameModal);
    renameBackdrop.addEventListener('click', closeRenameModal);
    renameSave.addEventListener('click', async () => {
      const val = (renameInput.value || '').trim();
      const col = (renameColor.value || '').trim();
      if (!val || !renamingTabId) { closeRenameModal(); return; }
      const tab = await dbGet(STORE_TABS, renamingTabId);
      if (tab) { tab.title = val; if (col) tab.color = col; await saveTabMeta(tab); await renderTabs(); }
      closeRenameModal(); renamingTabId = null;
    });
    document.addEventListener('keydown', async (e) => {
      if (renameModal.style.display === 'flex') {
        if (e.key === 'Escape') { e.preventDefault(); closeRenameModal(); }
        if (e.key === 'Enter') { e.preventDefault(); renameSave.click(); }
      }
    });

    // ---------- Init ----------
    let baseSummary = '';
    (async () => {
      const all = await loadTabs();
      activeTabId = (all[0] && all[0].id) || null;
      await renderTabs();
      if (activeTabId) await hydrateFromTab(activeTabId);
      updateReqIdSuggestions();
    })();
  </script>
</body>
</html>



